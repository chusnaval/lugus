<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title th:text="${pelicula.titulo}">Detalle</title>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
	crossorigin="anonymous"></script>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" crossorigin="anonymous">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<link th:href="@{/css/lugus.css}" rel="stylesheet">
</head>
<body class="container mt-4">
	<div th:replace="~{layout/header :: header}"></div>

	<form
		th:action="@{/peliculas/actualizar/{id}(id=${pelicula.id},filtroToken=${filtroToken})}"
		th:object="${nuevo}" method="post">
		<h2 th:text="${pelicula.titulo}">Título</h2>
		<input type="hidden" id="idPelicula" th:value="${pelicula.id}">

		<div class="row">
			<ul class="list-group mb-4 col-8">
				<li class="list-group-item row"><strong class="col-3">Título:</strong>
					<input type="text" th:value="${pelicula.titulo}"
					th:field="*{titulo}"></li>

				<li class="list-group-item row"><strong class="col-3">Título
						para Gestión:</strong> <input type="text" th:value="${pelicula.tituloGest}"
					th:field="*{tituloGest}"></li>

				<li class="list-group-item row"><strong class="col-3">Año:</strong>
					<input type="text" th:value="${pelicula.anyo}" th:field="*{anyo}"
					maxlength="4"></li>

				<li class="list-group-item row"><strong class="col-3">Formato:</strong>
					<select class="form-select" th:field="*{formatoCodigo}">
						<option th:each="f : ${T(lugus.model.Formato).valoresOrdenados()}"
							th:value="${f.id}" th:text="${f}"
							th:selected="${pelicula.formato.id == f.id}"></option>
				</select></li>
				<li class="list-group-item row"><strong class="col-3">Género:</strong>
					<select class="form-select" th:field="*{generoCodigo}">
						<option th:each="g : ${T(lugus.model.Genero).valoresOrdenados()}"
							th:value="${g.codigo}" th:text="${g.displayName}"
							th:selected="${pelicula.genero.codigo == g.codigo}"></option>
				</select></li>

				<li class="list-group-item row"><strong class="col-3">Pack:</strong>

					<input type="checkbox" th:value="${pelicula.pack}"
					th:field="*{pack}"> <strong class="col-3">Steelbook:</strong>

					<input type="checkbox" th:value="${pelicula.steelbook}"
					th:field="*{steelbook}"> <strong class="col-3">Funda:</strong>
					<input type="checkbox" th:value="${pelicula.funda}"
					th:field="*{funda}"> <strong class="col-3">Comprado:</strong>
					<input type="checkbox" th:value="${pelicula.comprado}"
					th:field="*{comprado}"></li>
				<li class="list-group-item row"><strong class="col-3">Localización:</strong>
					<select class="form-select" th:field="*{localizacionCodigo}">
						<option th:each="l : ${localizaciones}" th:value="${l.codigo}"
							th:text="${l.descripcion}"></option>
				</select></li>

				<li class="list-group-item row"><strong class="col-3">Código
						interno:</strong> <input type="text" th:value="${pelicula.codigo}"
					maxlength="4" readonly="readonly" disabled="disabled" ></li>
				<li class="list-group-item row"><strong class="col-3">Notas:</strong>
					<textarea th:value="${pelicula.notas}" maxlength="400"></textarea></li>
			</ul>
			<div class="col-3">
				<img id="caratulaImg" th:if="${pelicula.tieneCaratula == false}"
					src="../../image/placeholder.png" class="img-thumbnail"
					alt="Caratula" /> <img th:if="${pelicula.tieneCaratula == true}"
					th:src="@{/peliculas/{id}/image(id=${pelicula.id})}"
					class="img-thumbnail" alt="Caratula" />
			</div>
		</div>
		<br />
		<div class="col-md-2">
			<button type="submit" class="btn btn-primary w-100">Guardar</button>
		</div>
		<hr />
	</form>

	<div th:if="${pelicula.pack == true}">
		<h4>Películas del pack</h4>
		<div th:if="${pelicula.peliculasPack.empty}">
			<em>Este pack no contiene películas.</em>
		</div>
		<table th:unless="${pelicula.peliculasPack.empty}"
			class="table table-sm">
			<thead>
				<tr>
					<th>Título</th>
					<th>Año</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="h : ${pelicula.peliculasPack}">
					<td th:text="${h.titulo}"></td>
					<td th:text="${h.anyo}"></td>
				</tr>
			</tbody>
		</table>
		<hr />
	</div>

	<h4>Añadir caratula</h4>
	<form id="formCaratula"
		th:action="@{'/peliculas/' + ${pelicula.id} + '/caratula'}"
		method="post" th:object="${caratula}">
		<div class="row g-2">
			<div class="col-md-4">
				<input class="form-control" th:field="*{url}" placeholder="url" />
			</div>
			<div class="col-md-2">
				<select class="form-select" th:field="*{fuente}">
					<option th:each="f : ${fuentesList}" th:value="${f.id}"
						th:text="${f.descripcion}"></option>
				</select>
			</div>
			<div class="col-md-2">
				<button type="submit" class="btn btn-primary w-100">Añadir</button>
			</div>
		</div>
	</form>

	<h4>Añadir película al pack</h4>
	<form th:action="@{'/peliculas/' + ${pelicula.id} + '/hijo'}"
		th:object="${nuevoHijo}" method="post">
		<div class="row g-2">
			<div class="col-md-4">
				<input class="form-control" th:field="*{titulo}"
					placeholder="Título" />
			</div>
			<div class="col-md-2">
				<input type="number" class="form-control" th:field="*{anyo}"
					placeholder="Año" />
			</div>
			<div class="col-md-2">
				<select class="form-select" th:field="*{formatoCodigo}">
					<option th:each="f : ${T(lugus.model.Formato).valoresOrdenados()}"
						th:value="${f.id}" th:text="${f}"></option>
				</select>
			</div>
			<div class="col-md-2">
				<select class="form-select" th:field="*{generoCodigo}">
					<option th:each="g : ${T(lugus.model.Genero).valoresOrdenados()}"
						th:value="${g.codigo}" th:text="${g.displayName}"></option>
				</select>
			</div>
			<div class="col-md-2">
				<button type="submit" class="btn btn-primary w-100">Añadir</button>
			</div>
		</div>
	</form>
	<form th:action="@{/peliculas/volver(filtroToken=${filtroToken})}" method="post">
		<button type="submit" id="floatBtn" title="Volver">Volver</button>
	</form>
	<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('formCaratula');
    const caratulaImg = document.getElementById('caratulaImg');
	
    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // Evita recarga

        const actionUrl = form.getAttribute('action');
        const formData = new FormData(form);

        try {
            const response = await fetch(actionUrl, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Error al enviar la carátula');
            const idPelicula = document.getElementById('idPelicula');
            // Refrescar la imagen, evitando la caché del navegador
            const nuevaSrc = '/peliculas/' + idPelicula.value + '/image';
            caratulaImg.src = nuevaSrc;

        } catch (err) {
            console.error(err);
            alert('Hubo un error al añadir la carátula.');
        }
    });
    
    
});

</script>

</body>
</html>