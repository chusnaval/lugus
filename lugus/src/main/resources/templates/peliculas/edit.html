<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title th:text="${pelicula.titulo}">Detalle</title>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
	crossorigin="anonymous"></script>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" crossorigin="anonymous">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<link th:href="@{/css/lugus.css}" rel="stylesheet">
</head>
<body class="container mt-4">

	<h2  th:text="${pelicula.titulo}">Título</h2>
<input type="hidden" id="idPelicula" th:value="${pelicula.id}">

	<div class="row">
		<ul class="list-group mb-4 col-8">
			<li class="list-group-item row"><strong class="col-3">Año:</strong>
				<span th:text="${pelicula.anyo}"></span></li>
			<li class="list-group-item row"><strong class="col-3">Formato:</strong>
				<span th:text="${pelicula.formato}"></span></li>
			<li class="list-group-item row"><strong class="col-3">Género:</strong>
				<span th:text="${pelicula.genero.displayName}"></span></li>
			<li class="list-group-item row"><strong class="col-3">Código
					interno:</strong> <span th:text="${pelicula.codigo}"></span></li>
			<li class="list-group-item row"><strong class="col-3">Steelbook:</strong><i
				th:class="${pelicula.steelbook == true? 'fas fa-check-circle text-success col-1' : 'far fa-times-circle text-danger col-1'}"
				aria-hidden="true"></i><strong class="col-3">Funda</strong><i
				th:class="${pelicula.funda == true? 'fas fa-check-circle text-success col-1' : 'far fa-times-circle text-danger col-1'}"
				aria-hidden="true"></i><strong class="col-3">Comprado:</strong><i
				th:class="${pelicula.comprado == true? 'fas fa-check-circle text-success col-1' : 'far fa-times-circle text-danger col-1'}"
				aria-hidden="true"></i></li>
			<li class="list-group-item row"><strong class="col-3">Código
					interno:</strong> <span class="col-9" th:text="${pelicula.codigo}"></span></li>
		</ul>
		<div class="col-3">
			<img id="caratulaImg" th:if="${pelicula.tieneCaratula == false}"
				src="../../image/placeholder.png" class="img-thumbnail"
				alt="Caratula" /> <img th:if="${pelicula.tieneCaratula == true}"
				th:src="@{/peliculas/{id}/image(id=${pelicula.id})}"
				class="img-thumbnail" alt="Caratula" />
		</div>
	</div>
	<hr />

	<h4>Películas del pack</h4>
	<div th:if="${pelicula.peliculasPack.empty}">
		<em>Este pack no contiene películas.</em>
	</div>
	<table th:unless="${pelicula.peliculasPack.empty}"
		class="table table-sm">
		<thead>
			<tr>
				<th>Título</th>
				<th>Año</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="h : ${pelicula.peliculasPack}">
				<td th:text="${h.titulo}"></td>
				<td th:text="${h.anyo}"></td>
			</tr>
		</tbody>
	</table>

	<hr />

	<h4>Añadir caratula</h4>
	<form id="formCaratula"
		th:action="@{'/peliculas/' + ${pelicula.id} + '/caratula'}"
		method="post" th:object="${caratula}">
		<div class="row g-2">
			<div class="col-md-4">
				<input class="form-control" th:field="*{url}" placeholder="url" />
			</div>
			<div class="col-md-2">
				<select class="form-select" th:field="*{fuente}">
					<option th:each="f : ${fuentesList}" th:value="${f.id}"
						th:text="${f.descripcion}"></option>
				</select>
			</div>
			<div class="col-md-2">
				<button type="submit" class="btn btn-primary w-100">Añadir</button>
			</div>
		</div>
	</form>

	<h4>Añadir película al pack</h4>
	<form th:action="@{'/peliculas/' + ${pelicula.id} + '/hijo'}"
		th:object="${nuevoHijo}" method="post">
		<div class="row g-2">
			<div class="col-md-4">
				<input class="form-control" th:field="*{titulo}"
					placeholder="Título" />
			</div>
			<div class="col-md-2">
				<input type="number" class="form-control" th:field="*{anyo}"
					placeholder="Año" />
			</div>
			<div class="col-md-2">
				<select class="form-select" th:field="*{formatoCodigo}">
					<option th:each="f : ${T(lugus.model.Formato).valoresOrdenados()}"
						th:value="${f.id}" th:text="${f}"></option>
				</select>
			</div>
			<div class="col-md-2">
				<select class="form-select" th:field="*{generoCodigo}">
					<option th:each="g : ${T(lugus.model.Genero).valoresOrdenados()}"
						th:value="${g.codigo}" th:text="${g.displayName}"></option>
				</select>
			</div>
			<div class="col-md-2">
				<button type="submit" class="btn btn-primary w-100">Añadir</button>
			</div>
		</div>
	</form>

	<a th:href="@{/peliculas}" class="btn btn-link mt-3">← Volver al
		listado</a>

	<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('formCaratula');
    const caratulaImg = document.getElementById('caratulaImg');
	
    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // Evita recarga

        const actionUrl = form.getAttribute('action');
        const formData = new FormData(form);

        try {
            const response = await fetch(actionUrl, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Error al enviar la carátula');
            const idPelicula = document.getElementById('idPelicula');
            // Refrescar la imagen, evitando la caché del navegador
            const nuevaSrc = '/peliculas/' + idPelicula.value + '/image';
            caratulaImg.src = nuevaSrc;

        } catch (err) {
            console.error(err);
            alert('Hubo un error al añadir la carátula.');
        }
    });
});
</script>

</body>
</html>